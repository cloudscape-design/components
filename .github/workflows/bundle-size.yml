name: Measure bundle size

on:
  pull_request:
    branches:
      - main

permissions:
  statuses: write

jobs:
  measure:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v6
        name: Create a pending status on the commit
        with:
          script: |
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.payload.pull_request.head.sha,
              context: "Bundle size",
              state: 'pending',
              description: 'The app is being measured...',
              target_url: `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`
            })
      - name: Checkout the PR branch
        uses: actions/checkout@v3
      - name: Measure the base size of the Vite project
        run: |
          cp -r .github/workflows/bundle-size ../bundle-size
          cd ../bundle-size
          npm i --force
          npm run build
          mv output.txt output-base.txt
      - name: Measure the bundle size of this PR
        run: |
          npm i --force
          npm run build
          cd ../bundle-size
          npm i --force
          rm -rf node_modules/@cloudscape-design/components
          cp -r $GITHUB_WORKSPACE/lib/components node_modules/@cloudscape-design/components

          mv main-with-cloudscape.jsx main.jsx
          npm run build
          mv output.txt output-before.txt

      - name: Checkout the base branch
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Measure the bundle size of the base branch
        run: |
          npm i --force
          npm run build
          cd ../bundle-size
          npm i --force
          rm -rf node_modules/@cloudscape-design/components
          cp -r $GITHUB_WORKSPACE/lib/components node_modules/@cloudscape-design/components
          npm run build
          mv output.txt output-after.txt

      - name: Update the commit status with calculated results
        uses: actions/github-script@v6
        with:
          script: |
            const readFileSync = require('node:fs').readFileSync;
            const base = Number(readFileSync("../bundle-size/output-base.txt", "utf8"));
            const before = Number(readFileSync("../bundle-size/output-before.txt", "utf8")) - base;
            const after = Number(readFileSync("../bundle-size/output-after.txt", "utf8")) - base;
            console.log("Base:", base)
            console.log("Before:", before);
            console.log("After:", after);

            const increasePercent = (((after - before) / before) * 100).toFixed(2)
            const increaseKb = ((after - before) / 1000).toFixed(1);

            const message = `${after > before ? "+" : ""}${increasePercent} % / ${after > before ? "+" : ""}${increaseKb} KB (from ${before/1000} KB to ${after/1000} KB)`

            const name = "Bundle size";
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.payload.pull_request.head.sha,
              context: name,
              state: 'success',
              description: message,
              target_url: `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`
            })
      - name: Report failure
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.payload.pull_request.head.sha,
              context: name,
              state: 'error',
              description: "The workflow encountered an error.",
              target_url: `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`
            })
